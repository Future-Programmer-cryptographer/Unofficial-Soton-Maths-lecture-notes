name: Build & Deploy LaTeX Notes (Pandoc -> HTML)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Build HTML from all .tex files in notes/
        run: |
          mkdir -p _site

          # Make a simple landing page
          cat > _site/index.html <<'EOF'
          <!doctype html>
          <html>
          <head>
            <meta charset="utf-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1"/>
            <title>Notes</title>
          </head>
          <body>
            <h1>Unofficial University of Southampton BSc Mathematics Notes</h1>

            <p>These notes are not intended to be complete, poslished, or by any means a verbatim record of lectures. They exist largely because I was dissatisfied with solutiosn that worked without an intuitive explanation, and with substutitions and theorems that seemed to appear out of nowhere, and with textbooks that present mathematics as a finished product rather than a process of discovery.</p>

            <p>Much of what is written here comes from mements where something "worked", but I didn't understand why it had to work, or why it was the right approach to try in the first place. My notes try and address the gap between the formal mathematics taught and the thinking that leads up to it.</p>

            <p>Where appropriate, I include questions I initially found confusing, common pitfalls, and informal explanation alongside formal definitions and proofs. These notes reflect how ideas made sense to me, so if something here feels over-explained, that's usually become it once confused me.</p>

            <p>The notes may contain errors or simplifications. Always cross-check with official lecture notes, textbooks, or lecturersâ€™ guidance before relying on them. If you spot an error or have a question, feel free to email me at <a href="mailto:sd2g25@soton.ac.uk">sd2g25@soton.ac.uk</a>.</p>

            <ul>
          EOF

          # Build one HTML page per .tex file
          shopt -s nullglob
          for f in notes/*.tex; do
            base="$(basename "$f" .tex)"
            pandoc "$f" \
              -f latex+raw_tex \
              -t html \
              -s \
              --toc \
              --number-sections \
              --include-in-header=mathjax-config.html \
              -o "_site/${base}.html"
            echo "  <li><a href=\"${base}.html\">${base}</a></li>" >> _site/index.html
          done

          # Close landing page
          cat >> _site/index.html <<'EOF'
            </ul>
          </body>
          </html>
          EOF

          # Stop any Jekyll processing
          touch _site/.nojekyll

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
